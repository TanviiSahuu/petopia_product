name: CI/CD FOR PRODUCT APP

on:
  push:
    branches:
      - main  # Change this if you have a different default branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ğŸ›‘ Step 1: Checkout Repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ğŸ›‘ Step 2: Set up Python (For Django migrations & collectstatic)
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'  # Adjust according to your project

      # ğŸ›‘ Step 3: Install Dependencies (Adjust paths if needed)
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # ğŸ›‘ Step 4: Install Minikube & Start Cluster
      - name: Install Minikube
        run: |
         curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
         sudo install minikube-linux-amd64 /usr/local/bin/minikube

      - name: Start Minikube
        run: |
         minikube start --driver=docker
         minikube status

      # ğŸ›‘ Step 5: Load Kubeconfig (Required for Kubernetes Deployment)
      - name: Setup Kubeconfig
        run: |
          mkdir -p $HOME/.kube
          minikube kubectl -- config view --raw > $HOME/.kube/config
          kubectl config use-context minikube
        shell: bash

      # ğŸ›‘ Step 6: Log in to Docker Hub (Optional: Needed only if pushing images)
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}  # ğŸ‘‰ Insert in GitHub Secrets
          password: ${{ secrets.DOCKER_PASSWORD }}  # ğŸ‘‰ Insert in GitHub Secrets

      # ğŸ›‘ Step 7: Build & Push Docker Images for Microservices
      - name: Build & Push Docker Images
        run: |
          docker build -t tanviisahuu/petopia_product:latest .
          docker push tanviisahuu/petopia_product:latest

      # ğŸ›‘ Step 8: Apply Kubernetes Manifests (Using Minikube Kubectl)
      - name: Deploy to Minikube
        run: |
          minikube kubectl -- apply -f p-deployment.yml --validate=false
          minikube kubectl -- apply -f p-service.yml --validate=false
          minikube kubectl -- apply -f ingress.yml --validate=false

      # ğŸ›‘ Step 9: Verify Deployment
      - name: Verify Deployment
        run: |
          minikube kubectl -- get pods -A
          minikube kubectl -- get services -A
          minikube kubectl -- get ingress -A
